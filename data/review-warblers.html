<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Review: Spring Warblers</title>
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      background: #1a1a2e;
      color: #eee;
    }
    h1 { color: #4fc3f7; margin-bottom: 10px; }
    .instructions {
      background: #16213e;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      border-left: 4px solid #4fc3f7;
    }
    .instructions ul { margin: 10px 0 0 0; padding-left: 20px; }
    .instructions li { margin: 5px 0; }
    .stats-bar {
      background: #0d1520;
      padding: 12px 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }
    .stat { color: #888; }
    .stat strong { color: #fff; }
    .filter-bar {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
      align-items: center;
    }
    .filter-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      background: #333;
      color: #888;
    }
    .filter-btn.active { background: #4fc3f7; color: #000; }
    .filter-btn.warbler { background: #ff9800; color: #000; }
    .filter-btn.warbler.active { background: #ffb74d; }
    select {
      padding: 8px 12px;
      border-radius: 6px;
      border: none;
      background: #333;
      color: #fff;
      font-size: 14px;
    }
    .species-group {
      background: #16213e;
      border-radius: 12px;
      margin-bottom: 12px;
      overflow: hidden;
    }
    .species-header {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px 20px;
      cursor: pointer;
      user-select: none;
    }
    .species-header:hover { background: #1e2a4a; }
    .species-code {
      font-size: 20px;
      font-weight: bold;
      padding: 6px 12px;
      border-radius: 6px;
      color: #000;
    }
    .species-name { font-size: 16px; color: #aaa; }
    .species-stats { font-size: 14px; color: #666; margin-left: auto; }
    .expand-icon {
      font-size: 18px;
      color: #666;
      transition: transform 0.2s;
    }
    .species-group.expanded .expand-icon { transform: rotate(90deg); }
    .clips-list {
      display: none;
      padding: 0 20px 20px;
    }
    .species-group.expanded .clips-list { display: block; }
    .clip-row {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 12px;
      background: #1a1a2e;
      border-radius: 8px;
      margin-bottom: 8px;
      border: 2px solid transparent;
    }
    .clip-row:hover { background: #222244; }
    .clip-row.canonical { border-color: #4caf50; background: #1e3a1e; }
    .clip-row.rejected { border-color: #f44336; background: #3a1e1e; opacity: 0.6; }
    .clip-info {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 4px;
      min-width: 100px;
    }
    .clip-id { font-family: monospace; color: #4fc3f7; font-size: 14px; }
    .clip-badges { display: flex; gap: 6px; flex-wrap: wrap; }
    .badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 4px;
    }
    .badge.song { background: #2e7d32; color: #fff; }
    .badge.canonical { background: #4caf50; color: #fff; }
    .badge.rejected { background: #f44336; color: #fff; }
    .play-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      background: #4fc3f7;
      color: #000;
      min-width: 60px;
    }
    .play-btn:hover { background: #81d4fa; }
    .play-btn.playing { background: #f44336; }
    .actions {
      display: flex;
      gap: 8px;
      flex-shrink: 0;
    }
    .action-btn {
      padding: 6px 12px;
      border: 2px solid;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      font-size: 12px;
      background: transparent;
      transition: all 0.2s;
    }
    .action-btn.canonical-btn { border-color: #4caf50; color: #4caf50; }
    .action-btn.canonical-btn:hover, .action-btn.canonical-btn.active { background: #4caf50; color: #fff; }
    .action-btn.reject-btn { border-color: #f44336; color: #f44336; }
    .action-btn.reject-btn:hover, .action-btn.reject-btn.active { background: #f44336; color: #fff; }
    .output-section {
      background: #16213e;
      border-radius: 12px;
      padding: 20px;
      margin-top: 30px;
    }
    .output-section h2 { color: #4fc3f7; margin-top: 0; }
    #output {
      background: #1a1a2e;
      padding: 15px;
      border-radius: 8px;
      font-family: monospace;
      font-size: 12px;
      white-space: pre;
      overflow-x: auto;
      max-height: 400px;
      overflow-y: auto;
    }
    .btn-row {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }
    .copy-btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
      background: #4fc3f7;
      color: #000;
    }
    .copy-btn:hover { background: #81d4fa; }
    .no-clips {
      color: #888;
      font-style: italic;
      padding: 40px;
      text-align: center;
    }
  </style>
</head>
<body>
  <h1>Review: Spring Warblers</h1>

  <div class="instructions">
    <strong>Workflow:</strong>
    <ul>
      <li><strong>Click species header</strong> to expand and see clips</li>
      <li><strong>Play</strong> - Listen to clips (only one loads at a time for performance)</li>
      <li><strong>Canonical</strong> - Mark ONE clip per species as the best beginner-friendly example</li>
      <li><strong>Reject</strong> - Mark clips with background noise, other birds, or poor quality</li>
      <li><strong>Copy JSON</strong> at the bottom to add approved clips to clips.json</li>
    </ul>
  </div>

  <div class="stats-bar" id="stats-bar">Loading...</div>

  <div class="filter-bar">
    <button class="filter-btn warbler active" data-filter="warblers">Warblers Only</button>
    <button class="filter-btn" data-filter="all">All Species</button>
    <span style="color: #666; margin: 0 10px;">|</span>
    <select id="species-select">
      <option value="">Jump to species...</option>
    </select>
  </div>

  <div id="clips-container"><div class="no-clips">Loading...</div></div>

  <div class="output-section">
    <h2>Export: Approved Clips JSON</h2>
    <p style="color: #888; margin-bottom: 15px;">Copy this and share with Claude to add to clips.json</p>
    <div id="output">Loading...</div>
    <div class="btn-row">
      <button class="copy-btn" onclick="copyOutput()">Copy to Clipboard</button>
    </div>
  </div>

  <script>
    // All warbler species codes
    const WARBLER_CODES = new Set([
      'BWWA', 'GWWA', 'TEWA', 'OCWA', 'NAWA', 'NOPA', 'MAWA', 'CMWA',
      'BTBW', 'YRWA', 'BLBW', 'BLPW', 'BTNW', 'CSWA', 'BBWA', 'PRAW',
      'PAWA', 'PIWA', 'YTWA', 'PROW', 'COYE', 'CAWA', 'WIWA', 'AMRE',
      'OVEN', 'NOWA', 'LOWA', 'BAWW', 'CONW', 'MOWA', 'KEWA', 'HOWA',
      'SWWA', 'YEWA'
    ]);

    const SPECIES_INFO = {
      BWWA: { name: 'Blue-winged Warbler', color: '#FFD700' },
      GWWA: { name: 'Golden-winged Warbler', color: '#C0C0C0' },
      TEWA: { name: 'Tennessee Warbler', color: '#98FB98' },
      OCWA: { name: 'Orange-crowned Warbler', color: '#FFA500' },
      NAWA: { name: 'Nashville Warbler', color: '#ADFF2F' },
      NOPA: { name: 'Northern Parula', color: '#4169E1' },
      MAWA: { name: 'Magnolia Warbler', color: '#FFD700' },
      CMWA: { name: 'Cape May Warbler', color: '#FF6347' },
      BTBW: { name: 'Black-throated Blue Warbler', color: '#4682B4' },
      YRWA: { name: 'Yellow-rumped Warbler', color: '#FFD700' },
      BLBW: { name: 'Blackburnian Warbler', color: '#FF4500' },
      BLPW: { name: 'Blackpoll Warbler', color: '#2F4F4F' },
      BTNW: { name: 'Black-throated Green Warbler', color: '#228B22' },
      CSWA: { name: 'Chestnut-sided Warbler', color: '#8B4513' },
      BBWA: { name: 'Bay-breasted Warbler', color: '#A0522D' },
      PRAW: { name: 'Prairie Warbler', color: '#9ACD32' },
      PAWA: { name: 'Palm Warbler', color: '#D2691E' },
      PIWA: { name: 'Pine Warbler', color: '#6B8E23' },
      YTWA: { name: 'Yellow-throated Warbler', color: '#FFD700' },
      PROW: { name: 'Prothonotary Warbler', color: '#FFD700' },
      COYE: { name: 'Common Yellowthroat', color: '#FFD700' },
      CAWA: { name: 'Canada Warbler', color: '#4169E1' },
      WIWA: { name: "Wilson's Warbler", color: '#FFD700' },
      AMRE: { name: 'American Redstart', color: '#FF4500' },
      OVEN: { name: 'Ovenbird', color: '#D2691E' },
      NOWA: { name: 'Northern Waterthrush', color: '#8B7355' },
      LOWA: { name: 'Louisiana Waterthrush', color: '#A0522D' },
      BAWW: { name: 'Black-and-white Warbler', color: '#696969' },
      CONW: { name: 'Connecticut Warbler', color: '#808080' },
      MOWA: { name: 'Mourning Warbler', color: '#556B2F' },
      KEWA: { name: 'Kentucky Warbler', color: '#9ACD32' },
      HOWA: { name: 'Hooded Warbler', color: '#FFD700' },
      SWWA: { name: "Swainson's Warbler", color: '#8B7355' },
      YEWA: { name: 'Yellow Warbler', color: '#FFD700' },
      // Non-warblers
      NOCA: { name: 'Northern Cardinal', color: '#DC143C' },
      CAWR: { name: 'Carolina Wren', color: '#CD853F' },
      BLJA: { name: 'Blue Jay', color: '#4169E1' },
      AMCR: { name: 'American Crow', color: '#2F2F2F' },
      TUTI: { name: 'Tufted Titmouse', color: '#A0A0A0' },
      AMRO: { name: 'American Robin', color: '#8B4513' },
      AMGO: { name: 'American Goldfinch', color: '#FFD700' },
      MODO: { name: 'Mourning Dove', color: '#BC8F8F' },
      HOFI: { name: 'House Finch', color: '#DC143C' },
      WBNU: { name: 'White-breasted Nuthatch', color: '#4682B4' },
      BHNU: { name: 'Brown-headed Nuthatch', color: '#8B7355' },
      EABL: { name: 'Eastern Bluebird', color: '#4169E1' },
      GRCA: { name: 'Gray Catbird', color: '#696969' },
      CACH: { name: 'Carolina Chickadee', color: '#808080' },
      BRCR: { name: 'Brown Creeper', color: '#8B7355' },
      BRTH: { name: 'Brown Thrasher', color: '#CD853F' },
      HETH: { name: 'Hermit Thrush', color: '#8B7355' },
      RSHA: { name: 'Red-shouldered Hawk', color: '#8B4513' },
      BEKI: { name: 'Belted Kingfisher', color: '#4682B4' },
      DOWO: { name: 'Downy Woodpecker', color: '#2F2F2F' },
      HAWO: { name: 'Hairy Woodpecker', color: '#2F2F2F' },
      RBWO: { name: 'Red-bellied Woodpecker', color: '#DC143C' },
      PIWO: { name: 'Pileated Woodpecker', color: '#DC143C' },
      YBSA: { name: 'Yellow-bellied Sapsucker', color: '#FFD700' },
      NOFL: { name: 'Northern Flicker', color: '#CD853F' },
      RHWO: { name: 'Red-headed Woodpecker', color: '#DC143C' },
      SOSP: { name: 'Song Sparrow', color: '#8B7355' },
      WTSP: { name: 'White-throated Sparrow', color: '#808080' },
      CHSP: { name: 'Chipping Sparrow', color: '#CD853F' },
      SWSP: { name: 'Swamp Sparrow', color: '#8B4513' },
      FISP: { name: 'Field Sparrow', color: '#DEB887' },
      SASP: { name: 'Savannah Sparrow', color: '#9ACD32' },
      LISP: { name: "Lincoln's Sparrow", color: '#8B7355' },
    };

    let newClips = [];
    let decisions = { canonical: {}, rejected: [] };
    let currentFilter = 'warblers';
    let currentAudio = null;
    let expandedSpecies = new Set();

    async function init() {
      try {
        const response = await fetch('new_clips.json');
        newClips = await response.json();
        console.log(`Loaded ${newClips.length} clips`);
      } catch (e) {
        console.error('Error loading new_clips.json:', e);
        document.getElementById('clips-container').innerHTML = `
          <div class="no-clips">
            Could not load new_clips.json<br><br>
            Run: <code>python scripts/scan_new_clips.py</code>
          </div>`;
        return;
      }

      populateSpeciesSelect();
      renderAll();
    }

    function populateSpeciesSelect() {
      const select = document.getElementById('species-select');
      const species = [...new Set(newClips.map(c => c.species_code))].sort();

      for (const code of species) {
        const info = SPECIES_INFO[code] || { name: code };
        const opt = document.createElement('option');
        opt.value = code;
        opt.textContent = `${code} - ${info.name}`;
        select.appendChild(opt);
      }

      select.addEventListener('change', (e) => {
        if (e.target.value) {
          expandedSpecies.add(e.target.value);
          renderClips();
          // Scroll to species
          setTimeout(() => {
            const el = document.getElementById(`species-${e.target.value}`);
            if (el) el.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }, 100);
          e.target.value = '';
        }
      });
    }

    function renderAll() {
      renderStats();
      renderClips();
      updateOutput();
    }

    function renderStats() {
      const filtered = getFilteredClips();
      const total = filtered.length;
      const canonical = Object.values(decisions.canonical).filter(id =>
        filtered.some(c => c.clip_id === id)
      ).length;
      const rejected = decisions.rejected.filter(id =>
        filtered.some(c => c.clip_id === id)
      ).length;
      const species = new Set(filtered.map(c => c.species_code)).size;

      document.getElementById('stats-bar').innerHTML = `
        <span class="stat"><strong>${total}</strong> clips</span>
        <span class="stat"><strong>${species}</strong> species</span>
        <span class="stat"><strong>${canonical}</strong> canonical</span>
        <span class="stat"><strong>${rejected}</strong> rejected</span>
      `;
    }

    function getFilteredClips() {
      if (currentFilter === 'warblers') {
        return newClips.filter(c => WARBLER_CODES.has(c.species_code));
      }
      return newClips;
    }

    function renderClips() {
      const container = document.getElementById('clips-container');
      const clips = getFilteredClips();

      if (clips.length === 0) {
        container.innerHTML = `<div class="no-clips">No clips found.</div>`;
        return;
      }

      container.innerHTML = '';

      // Group by species
      const bySpecies = {};
      for (const clip of clips) {
        const code = clip.species_code;
        if (!bySpecies[code]) bySpecies[code] = [];
        bySpecies[code].push(clip);
      }

      const speciesOrder = Object.keys(bySpecies).sort();

      for (const code of speciesOrder) {
        const speciesClips = bySpecies[code];
        const info = SPECIES_INFO[code] || { name: code, color: '#888' };
        const isExpanded = expandedSpecies.has(code);

        const canonicalCount = speciesClips.filter(c => decisions.canonical[code] === c.clip_id).length;
        const rejectedCount = speciesClips.filter(c => decisions.rejected.includes(c.clip_id)).length;
        const activeCount = speciesClips.length - rejectedCount;

        const group = document.createElement('div');
        group.className = 'species-group' + (isExpanded ? ' expanded' : '');
        group.id = `species-${code}`;

        const header = document.createElement('div');
        header.className = 'species-header';
        header.innerHTML = `
          <span class="expand-icon">&#9654;</span>
          <span class="species-code" style="background: ${info.color}">${code}</span>
          <span class="species-name">${info.name}</span>
          <span class="species-stats">
            ${canonicalCount ? '&#9733; ' : ''}${activeCount}/${speciesClips.length} clips
          </span>
        `;
        header.onclick = () => {
          if (expandedSpecies.has(code)) {
            expandedSpecies.delete(code);
          } else {
            expandedSpecies.add(code);
          }
          renderClips();
        };

        const clipsList = document.createElement('div');
        clipsList.className = 'clips-list';

        if (isExpanded) {
          for (const clip of speciesClips) {
            const isCanonical = decisions.canonical[code] === clip.clip_id;
            const isRejected = decisions.rejected.includes(clip.clip_id);

            const row = document.createElement('div');
            row.className = 'clip-row';
            if (isCanonical) row.classList.add('canonical');
            if (isRejected) row.classList.add('rejected');

            const badges = [];
            badges.push(`<span class="badge song">song</span>`);
            if (isCanonical) badges.push('<span class="badge canonical">CANONICAL</span>');
            if (isRejected) badges.push('<span class="badge rejected">REJECTED</span>');

            row.innerHTML = `
              <div class="clip-info">
                <span class="clip-id">${clip.source_id || clip.clip_id}</span>
                <div class="clip-badges">${badges.join('')}</div>
              </div>
              <button class="play-btn" data-clip="${clip.clip_id}">Play</button>
              <div class="actions">
                <button class="action-btn canonical-btn ${isCanonical ? 'active' : ''}"
                        onclick="toggleCanonical('${code}', '${clip.clip_id}')"
                        ${isRejected ? 'disabled' : ''}>
                  Canonical
                </button>
                <button class="action-btn reject-btn ${isRejected ? 'active' : ''}"
                        onclick="toggleRejected('${clip.clip_id}', '${code}')">
                  Reject
                </button>
              </div>
            `;

            // Play button handler
            const playBtn = row.querySelector('.play-btn');
            playBtn.onclick = () => playClip(clip.clip_id, playBtn);

            clipsList.appendChild(row);
          }
        }

        group.appendChild(header);
        group.appendChild(clipsList);
        container.appendChild(group);
      }
    }

    function playClip(clipId, btn) {
      // Stop current audio
      if (currentAudio) {
        currentAudio.pause();
        currentAudio = null;
        document.querySelectorAll('.play-btn.playing').forEach(b => {
          b.classList.remove('playing');
          b.textContent = 'Play';
        });
      }

      // If clicking same button, just stop
      if (btn.classList.contains('playing')) {
        return;
      }

      // Play new audio
      const audio = new Audio(`clips/${clipId}.wav`);
      currentAudio = audio;
      btn.classList.add('playing');
      btn.textContent = 'Stop';

      audio.play();
      audio.onended = () => {
        btn.classList.remove('playing');
        btn.textContent = 'Play';
        currentAudio = null;
      };
    }

    function toggleCanonical(speciesCode, clipId) {
      if (decisions.canonical[speciesCode] === clipId) {
        delete decisions.canonical[speciesCode];
      } else {
        decisions.canonical[speciesCode] = clipId;
      }
      renderAll();
    }

    function toggleRejected(clipId, speciesCode) {
      const idx = decisions.rejected.indexOf(clipId);
      if (idx >= 0) {
        decisions.rejected.splice(idx, 1);
      } else {
        decisions.rejected.push(clipId);
        if (decisions.canonical[speciesCode] === clipId) {
          delete decisions.canonical[speciesCode];
        }
      }
      renderAll();
    }

    function updateOutput() {
      // Only export the decisions - much smaller!
      const output = {
        canonical: decisions.canonical,  // { AMRE: "AMRE_12345", ... }
        rejected: decisions.rejected,    // ["BLBW_67890", ...]
      };

      document.getElementById('output').textContent = JSON.stringify(output, null, 2);
    }

    function copyOutput() {
      const output = document.getElementById('output').textContent;
      navigator.clipboard.writeText(output).then(() => {
        const btn = document.querySelector('.copy-btn');
        btn.textContent = 'Copied!';
        setTimeout(() => btn.textContent = 'Copy to Clipboard', 2000);
      });
    }

    // Filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentFilter = btn.dataset.filter;
        expandedSpecies.clear();
        renderAll();
      });
    });

    init();
  </script>
</body>
</html>
